CREATE OR REPLACE FUNCTION set_completed_at() RETURNS TRIGGER AS $$ BEGIN IF NEW.status = 'completed' AND OLD.status != 'completed' THEN NEW.completed_at = NOW(); ELSIF NEW.status != 'completed' AND OLD.status = 'completed' THEN NEW.completed_at = NULL; END IF; RETURN NEW; END; $$ language 'plpgsql'; CREATE TRIGGER set_task_completed_at BEFORE UPDATE ON public.tasks FOR EACH ROW EXECUTE FUNCTION set_completed_at();